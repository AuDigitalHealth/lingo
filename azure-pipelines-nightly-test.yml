name: snomio-$(Date:yyyyMMdd)$(Rev:.r)_$(Build.SourceBranchName)

trigger:
  - main



schedules:
  - cron: "0 11 * * *"
    displayName: Nightly Run
    branches:
      include:
        - main
    always: true


variables:
  mavenCache: $(Pipeline.Workspace)/.m2/repository
  mavenOptions: '-Dmaven.repo.local=$(mavenCache) -Dmaven.settings.security=never'
  scheduledRun: $[eq(variables['Build.Reason'], 'Schedule')]


pool:
  vmImage: ubuntu-latest

jobs:

  - job: snomio_nightly_test
    displayName: Run nightly test
    condition: eq(variables.scheduledRun, 'True')
    timeoutInMinutes: 60
    steps:
      - script: |
          cd ui
          npm install cypress --save-dev
          npm install dotenv
          export CYPRESS_BASE_URL="https://dev-snomio.ihtsdotools.org"
          export cypress_frontend_url="https://dev-snomio.ihtsdotools.org"
          export cypress_ims_username=$(imsUsername)
          export cypress_ims_password=$(imsPassword)
          export cypress_ims_url="https://dev-ims.ihtsdotools.org"
          export cypress_apUrl="https://dev-snowstorm.ihtsdotools.org"
          export cypress_apProjectKey="AUAMT"
          export cypress_apDefaultBranch="MAIN/SNOMEDCT-AU/AUAMT"
          
          npx cypress run
        displayName: 'Set environment variables and run Cypress tests'